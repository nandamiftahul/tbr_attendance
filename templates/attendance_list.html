<!-- templates/attendance_list.html -->
{% extends 'base.html' %}
{% block title %}Records · Attendance{% endblock %}
{% block content %}

<div class="card">
  <h2>Attendance Records</h2>
  <form method="get" style="display:grid; grid-template-columns: repeat(5, 1fr); gap:10px; align-items:end;">
    <div>
      <label>Start</label>
      <input type="date" name="start" value="{{ start or '' }}">
    </div>
    <div>
      <label>End</label>
      <input type="date" name="end" value="{{ end or '' }}">
    </div>
    <div>
      <label>Employee</label>
      <input name="employee" placeholder="Name contains..." value="{{ emp or '' }}">
    </div>

    <div style="display:flex; gap:8px;">
      <button class="btn" type="submit">Filter</button>
      <a class="btn secondary" href="{{ url_for('attendance_export_csv', start=start, end=end, employee=emp) }}">Export CSV</a>
      <a class="btn secondary" href="{{ url_for('attendance_export_xlsx', start=start, end=end, employee=emp) }}">Export Excel</a>
    </div>

    <div></div>
  </form>
</div>

<div class="card" style="margin-top:12px;">
  <h2 style="margin-bottom:10px;">Import Attendance (JSON)</h2>

  <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:end;">
    <div style="min-width:260px;">
      <label>JSON File</label>
      <input id="attImportFile" type="file" accept="application/json">
    </div>

    <label style="display:flex; gap:8px; align-items:center; margin:0;">
      <input id="attImportOverwrite" type="checkbox">
      Overwrite existing check_in / check_out
    </label>

    <button class="btn" type="button" onclick="uploadAttendanceJson()">
      Upload JSON
    </button>
  </div>

  <div id="attImportResult"
       style="margin-top:10px; font-size:13px; opacity:.9;">
  </div>
</div>


<div class="card" style="margin-top:12px;">
  <div class="tablewrap">
    <table class="table table-fixed">
      <thead>
        <tr>
          <th class="col-date">Date</th>
          <th class="col-code">Code</th>
          <th class="col-name">Name</th>
          <th class="col-dept">Dept</th>
          <th class="col-ci">Check-In</th>
          <th class="col-co">Check-Out</th>
          <th class="col-hours">Hours</th>
          <th class="col-status">Status</th>
          <th class="col-note">Note</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td>{{ r.work_date }}</td>
          <td>{{ r.employee.code }}</td>
          <td class="truncate" title="{{ r.employee.name }}">{{ r.employee.name }}</td>
          <td class="truncate" title="{{ r.employee.dept or '' }}">{{ r.employee.dept or '' }}</td>

          <td>
            <div class="dt">{{ r.check_in_local_str }}</div>
            <div class="meta">IP: {{ r.check_in_ip or '' }}</div>
            <div class="meta ua" title="{{ r.check_in_ua or '' }}">UA: {{ r.check_in_ua or '' }}</div>
          </td>

          <td>
            <div class="dt">{{ r.check_out_local_str }}</div>
            <div class="meta">IP: {{ r.check_out_ip or '' }}</div>
            <div class="meta ua" title="{{ r.check_out_ua or '' }}">UA: {{ r.check_out_ua or '' }}</div>
          </td>

          <td>{{ '%.2f'|format(r.duration_hours) }}</td>
          <td><span class="badge">{{ r.status }}</span></td>
          <td class="truncate" title="{{ r.note or '' }}">{{ r.note or '' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div style="opacity:.8; font-size:12px; margin-top:8px;">
    Tip: swipe/drag the table left-right to see all columns.
  </div>
</div>

<style>
/* make table scrollable horizontally */
.tablewrap{
  width:100%;
  overflow-x:auto;
  -webkit-overflow-scrolling: touch;
  border-radius: 12px;
}

/* keep table readable */
.table-fixed{
  min-width: 1100px;   /* important so scroll appears */
}

.table-fixed th, .table-fixed td{
  vertical-align: top;
  white-space: nowrap; /* default tetap nowrap */
}

/* allow some columns to wrap/fit */
/* kolom yang memang perlu wrap agar kebaca */
.col-ci, .col-co, .col-note { 
  white-space: normal !important;
  min-width: 320px;          /* sebelumnya 260, kita lebarkan */
}

/* UA dan meta boleh wrap + pecah kata panjang */
/* perbesar kolom check-in/out */
.col-ci, .col-co{
  white-space: normal;
  min-width: 380px;   /* dari 260 -> 380 */
}

/* note diperkecil */
.col-note{
  white-space: normal;
  min-width: 160px;   /* dari 260 -> 160 */
}

/* kolom-kolom kecil */
.col-date{ min-width: 95px; }    /* dari 110 */
.col-code{ min-width: 60px; }    /* dari 80 */
.col-hours{ min-width: 60px; }   /* dari 80 */
.col-status{ min-width: 90px; }  /* dari 110 */

/* kolom identitas biarin */
.col-name{ min-width: 180px; }
.col-dept{ min-width: 140px; }


.dt{ font-weight: 600; }
.meta{ font-size: 12px; opacity: .9; }

/* truncate long text */
.truncate{
  max-width: 260px;          /* naikin dari 220 biar lebih lega */
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* ensure text contrast (in case base theme makes it faint) */
.table-fixed td, .table-fixed th { color: rgba(255,255,255,0.92); }
</style>

<script>
async function uploadAttendanceJson(){
  const fileEl = document.getElementById("attImportFile");
  const overwrite = document.getElementById("attImportOverwrite").checked;
  const out = document.getElementById("attImportResult");

  out.textContent = "";

  if(!fileEl.files || !fileEl.files[0]){
    out.textContent = "Pilih file JSON dulu.";
    return;
  }

  const fd = new FormData();
  fd.append("file", fileEl.files[0]);

  out.textContent = "Uploading...";

  try{
    const url = "/api/admin/attendance/import" + (overwrite ? "?overwrite=1" : "");
    const res = await fetch(url, { method: "POST", body: fd });
    const j = await res.json();

    if(!res.ok || !j.ok){
      out.textContent = "Gagal: " + (j.error || ("HTTP " + res.status));
      return;
    }

    out.textContent =
      `Sukses ✔ created=${j.created}, updated=${j.updated}, skipped=${j.skipped}`;

    setTimeout(()=>location.reload(), 800);

  }catch(e){
    out.textContent = "Error: " + e;
  }
}
</script>


{% endblock %}
