{% extends 'base.html' %}
{% block title %}Approvals · Attendance{% endblock %}
{% block content %}

<div class="card">
  <h2>Leave/Sick/WFH Approvals</h2>
  <p style="opacity:.85;margin-top:-6px;">
    Approve and Reject are shown side-by-side. ID/Type/Status are compact to fit nicely.
  </p>
</div>

{% if (current_user.role or '')|lower == 'admin' %}
<div class="card" style="margin-top:12px;">
  <h2 style="margin-bottom:6px;">Approval Flow Settings</h2>
  <p style="opacity:.85;margin-top:-6px;">
    Set who approves <b>Manager</b> per department and who approves <b>HRD</b> (global or per department).
  </p>

  <form method="post" action="{{ url_for('approval_routes_set') }}"
        style="display:grid; grid-template-columns: 160px 1fr 1fr auto auto; gap:10px; align-items:end;">

    <div>
      <label>Stage</label>
      <select name="stage" required>
        <option value="manager">manager</option>
        <option value="hrd">hrd</option>
      </select>
    </div>

    <div>
      <label>Department</label>
      <select name="dept">
        <option value="">(global/default)</option>
        {% for d in (depts or []) %}
          <option value="{{ d }}">{{ d }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label>Approver User</label>
      <select name="approver_user_id" required>
        {% for u in (users or []) %}
          <option value="{{ u.id }}">{{ u.name }} — {{ u.email }} ({{ u.role }})</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <button class="btn" type="submit">Save</button>
    </div>

    <div>
      <button class="btn btn-outline-danger" type="submit" name="clear" value="1"
              onclick="return confirm('Clear route for selected stage+dept?');">Clear</button>
    </div>
  </form>

  <div style="margin-top:12px;">
    <div style="font-weight:700;margin-bottom:6px;">Current Routes</div>
    <div class="tablewrap">
      <table class="table table-fixed" style="min-width:760px;">
        <thead>
          <tr>
            <th style="width:130px;">Stage</th>
            <th style="width:220px;">Dept</th>
            <th>Approver</th>
          </tr>
        </thead>
        <tbody>
          {% for rr in (routes or []) %}
          <tr>
            <td>{{ rr.stage }}</td>
            <td>{{ rr.dept or '(global/default)' }}</td>
            <td>{{ rr.approver_user_id }}</td>
          </tr>
          {% endfor %}
          {% if not (routes or []) %}
          <tr><td colspan="3" style="opacity:.8;">No routes set. System will fallback to old role/department logic.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

<div class="card" style="margin-top:12px;">
  <div class="tablewrap">
    <table class="table table-fixed">
      <thead>
        <tr>
          <th class="col-id">ID</th>
          <th class="col-emp">Employee</th>
          <th class="col-type">Type</th>
          <th class="col-dates">Dates</th>
          <th class="col-status">Status</th>
          <th class="col-reason">Reason</th>
          <th class="col-actions">Actions</th>
        </tr>
      </thead>

      <tbody>
        {% for r in rows %}
        <tr>
          <td class="col-id">{{ r.id }}</td>
          <td class="truncate col-emp" title="{{ r.employee.code }} — {{ r.employee.name }}">
            {{ r.employee.code }} — {{ r.employee.name }}
          </td>
          <td class="col-type">
            <span class="badge badge-{{ r.type }}">{{ r.type }}</span>
          </td>
          <td class="col-dates">{{ r.start_date }} → {{ r.end_date }}</td>
          <td class="col-status">
            <span class="badge badge-status badge-{{ r.status }}">{{ r.status }}</span>
          </td>
          <td class="truncate col-reason" title="{{ r.reason or '' }}">{{ r.reason or '' }}</td>

          <td class="actions-cell col-actions">
            {% if r.status in ['pending_manager','pending_hrd'] %}
              <div class="actions-row">
                <form method="post" action="{{ url_for('leave_approve', rid=r.id) }}">
                  <button class="btn" type="submit">✓ Approve</button>
                </form>

                <form method="post" action="{{ url_for('leave_reject', rid=r.id) }}"
                      onsubmit="return confirm('Reject request #{{ r.id }}?');">
                  <button class="btn btn-outline-danger" type="submit">✕ Reject</button>
                </form>
              </div>
            {% else %}
              <small style="opacity:.85;">
                manager_by {{ r.manager_approved_by or '-' }} · hrd_by {{ r.hrd_approved_by or '-' }}
              </small>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<style>
.tablewrap{ width:100%; overflow-x:auto; -webkit-overflow-scrolling: touch; border-radius: 12px; }
.table-fixed{ min-width: 1100px; }
.table-fixed td, .table-fixed th{ vertical-align: top; white-space: nowrap; }
.col-id{ width:60px; text-align:center; }
.col-type{ width:95px; text-align:center; }
.col-status{ width:110px; text-align:center; }
.col-actions{ width:240px; }
.col-emp{ min-width:230px; }
.col-dates{ min-width:200px; }
.col-reason{ min-width:260px; }
.actions-cell{ overflow: visible !important; text-overflow: clip !important; }
.actions-row{ display:flex; gap:10px; align-items:center; }
.actions-row form{ margin:0; }
.truncate{ overflow:hidden; text-overflow:ellipsis; max-width:380px; }
.badge{ display:inline-block; padding:3px 10px; border-radius:999px; font-size:12px; background: rgba(255,255,255,0.12); }
.btn-outline-danger{ background: transparent; border: 1px solid #ff8080; color: #ff8080; }
.btn-outline-danger:hover{ background: #ff8080; color: #001018; }
</style>

{% endblock %}
